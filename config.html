<!DOCTYPE html>
<html>
<head>
  <title>Config</title>
  <style>
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
    }
    th {
      text-align: left;
      background-color: #f0f0f0;
    }
    .hidden {
      display: none;
    }
    .element-block {
      border: 1px solid #aaa;
      padding: 10px;
      margin-top: 20px;
    }
  </style>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

</head>
<body>
  <h1>Configuration Page</h1>

  <label for="element-count">Enter how many elements are in your system:</label>
  <input type="number" id="element-count" min="1" step="1" />
  <button id="define-elements">Next</button>

  <form id="config-form" class="hidden"></form>

  <br>
  <button id="generate-config" class="hidden">Generate</button>
  <button id="go-to-home">Back to Home</button>

  <script>
    const configForm = document.getElementById('config-form');
    const generateBtn = document.getElementById('generate-config');

    const elementInputs = {
      'Bundle': ['core_diameter', 'core_spacing'],
      'Lens': ['wavelength', 'magnification','na'],
      'Detector': ['pixel_x', 'pixel_y', 'binning']
    };
    const parameterUnits = {
      // Bundle
      core_diameter: 'mm',
      core_spacing: 'mm',

      // Lens
      wavelength: 'mm',
      magnification: '×',
      na: 'NA',

      // Detector
      pixel_x: 'mm',
      pixel_y: 'mm',
      binning: 'factor'
    };

    document.getElementById('define-elements').addEventListener('click', () => {
      const count = parseInt(document.getElementById('element-count').value);
      if (isNaN(count) || count <= 0) {
        alert("Please enter a valid number greater than 0.");
        return;
      }

      configForm.innerHTML = "";
      configForm.classList.remove('hidden');
      generateBtn.classList.remove('hidden');

      for (let i = 1; i <= count; i++) {
        const block = document.createElement('div');
        block.className = 'element-block';
        block.dataset.index = i;
        block.innerHTML = `
          <h3>Element ${i}</h3>
          <label>Type:
            <select class="type-select" data-element="${i}">
              <option value="">-- Select --</option>
              <option value="Bundle">Bundle</option>
              <option value="Lens">Lens</option>
              <option value="Detector">Detector</option>
            </select>
          </label>
          <div class="element-fields" id="fields-${i}"></div>
        `;
        configForm.appendChild(block);
      }
    });

    configForm.addEventListener('change', (e) => {
      if (e.target.classList.contains('type-select')) {
        const elementId = e.target.dataset.element;
        const selectedType = e.target.value;
        const fieldsContainer = document.getElementById(`fields-${elementId}`);
        fieldsContainer.innerHTML = "";

        if (elementInputs[selectedType]) {
          const table = document.createElement('table');
          table.innerHTML = `<tr><th>Parameter</th><th>Value</th><th>Unit</th></tr>`;
          elementInputs[selectedType].forEach(name => {
            const label = name.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            const unit = parameterUnits[name] || '';
            table.innerHTML += `
              <tr>
                <td>${label}</td>
                <td><input type="text" name="${name}" /></td>
                <td>${unit}</td>
              </tr>`;
          });

          table.setAttribute('data-type', selectedType);
          fieldsContainer.appendChild(table);
        }
      }
    });

    generateBtn.addEventListener('click', () => {
      const blocks = document.querySelectorAll('.element-block');
      const configData = [];

      blocks.forEach(block => {
        const type = block.querySelector('.type-select').value;
        if (!type) return;

        const inputs = block.querySelectorAll('input');
        const element = { type };
        inputs.forEach(input => {
          element[input.name] = input.value;
        });

        configData.push(element);
      });

      // Send configData to main process for saving
      if (window.require) {
        const { ipcRenderer } = require('electron');
        ipcRenderer.send('save-config', configData);
        alert("Configuration sent to backend for saving!");

        document.getElementById('mtf-section').classList.remove('hidden');
        loadCurrentMTF();
      } else {
        console.warn("Not running in Electron.");
      }
    });
  </script>

  <script src="renderer.js"></script>
  <div id="mtf-section" class="hidden">
  <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
    <button id="prev-mtf">←</button>
    <h3 id="mtf-label" style="margin: 0;">MTF1 (Bundle)</h3>
    <button id="next-mtf">→</button>

  <!-- Circle toggle buttons -->
  <button id="mode-3d" style="border-radius: 50%; width: 32px; height: 32px;">3D</button>
  <button id="mode-2d" style="border-radius: 50%; width: 32px; height: 32px;">2D</button>
</div>

<div id="matrix-plot" style="width: 800px; height: 600px;"></div>

<script>
  const fs = require('fs');
  const path = require('path');

  const mtfFiles = [
    { file: 'mtf1_output.json', label: 'MTF1 (Bundle)' },
    { file: 'mtf2_output.json', label: 'MTF2 (Lens)' },
    { file: 'mtf3_output.json', label: 'MTF3 (Detector)' },
    { file: 'mtf4_output.json', label: 'Combined MTF' }
  ];

  let currentIndex = 0;
  let viewMode = '3d'; // '3d' or '2d'

  function loadCurrentMTF() {
    const { file, label } = mtfFiles[currentIndex];
    const matrixPath = path.join(__dirname, 'build', file);
    document.getElementById('mtf-label').textContent = label;

    if (fs.existsSync(matrixPath)) {
      const matrixData = JSON.parse(fs.readFileSync(matrixPath));
      const numRows = matrixData.length;
      const numCols = matrixData[0].length;

      const xFull = Array.from({ length: numCols }, (_, i) => i - (numCols - 1) / 2);
      const yFull = Array.from({ length: numRows }, (_, i) => i - (numRows - 1) / 2);

      const xStart = Math.ceil(numCols / 2);
      const yStart = Math.ceil(numRows / 2);

      const x = xFull.slice(xStart);
      const y = yFull.slice(yStart);
      const z = matrixData.slice(yStart).map(row => row.slice(xStart));

      const data = viewMode === '3d'
        ? [{
            z: z,
            x: x,
            y: y,
            type: 'surface',
            colorscale: 'Rdbu'
          }]
        : [{
          x: x,  // Spatial frequency (approx)
          y: z[Math.floor(z.length / 2)],  // Mid-row slice
          type: 'scatter',
          mode: 'lines+markers',
          name: 'MTF vs Spatial Frequency',
          line: { shape: 'spline' }
        }];

      const layout = {
        title: label,
        ...(viewMode === '3d'
          ? {
              scene: {
                xaxis: { title: 'X ≥ 0' },
                yaxis: { title: 'Y ≥ 0' },
                zaxis: { title: 'MTF Value' }
              }
            }
          : {
              xaxis: { title: 'X ≥ 0' },
              yaxis: { title: 'Y ≥ 0' }
            })
      };

      Plotly.newPlot('matrix-plot', data, layout);
    } else {
      console.warn(`${file} not found.`);
    }
  }

  document.getElementById('prev-mtf').addEventListener('click', () => {
    currentIndex = (currentIndex - 1 + mtfFiles.length) % mtfFiles.length;
    loadCurrentMTF();
  });

  document.getElementById('next-mtf').addEventListener('click', () => {
    currentIndex = (currentIndex + 1) % mtfFiles.length;
    loadCurrentMTF();
  });

  document.getElementById('mode-3d').addEventListener('click', () => {
    viewMode = '3d';
    loadCurrentMTF();
  });

  document.getElementById('mode-2d').addEventListener('click', () => {
    viewMode = '2d';
    loadCurrentMTF();
  });

</script>



</body>
</html>
